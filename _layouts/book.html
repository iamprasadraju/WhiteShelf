---
layout: default
---
<article class="book-detail">
  <h1 class="book-title-mobile">{{ page.title }}</h1>
  
  <div class="book-header-row">
    <div class="book-cover-wrapper">
      {% if page.cover_url %}
      <img src="{{ page.cover_url }}" alt="{{ page.title }}" class="book-cover-img">
      {% else %}
      <div class="book-cover-placeholder">No Cover</div>
      {% endif %}
    </div>
    
    <div class="book-info-grid">
      <div class="book-info-meta">
        {% if page.authors %}
        <div class="meta-row">
          <span class="meta-label">Author</span>
          <span class="meta-value">{{ page.authors | join: ", " }}</span>
        </div>
        {% endif %}
        {% if page.publish_year or page.pages or page.edition_count or page.publisher %}
        <div class="meta-list">
          {% if page.publish_year %}
          <div class="meta-row">
            <span class="meta-label">Year</span>
            <span class="meta-value">{{ page.publish_year }}</span>
          </div>
          {% endif %}
          {% if page.pages %}
          <div class="meta-row">
            <span class="meta-label">Pages</span>
            <span class="meta-value">{{ page.pages }}</span>
          </div>
          {% endif %}
          {% if page.edition_count %}
          <div class="meta-row">
            <span class="meta-label">Editions</span>
            <span class="meta-value">{{ page.edition_count }}</span>
          </div>
          {% endif %}
          {% if page.publisher %}
          <div class="meta-row">
            <span class="meta-label">Publisher</span>
            <span class="meta-value">{{ page.publisher }}</span>
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% if page.pdf_url != "" and page.pdf_url != nil %}
        <a href="{{ page.pdf_url }}" target="_blank" class="book-link">Open Book</a>
        {% endif %}
      </div>
    </div>
  </div>
  
  {% if page.subjects %}
  <div class="book-section">
    <h3>Subjects</h3>
    <div class="book-badges">
      {% for subject in page.subjects %}
      <span class="book-badge">{{ subject }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  {% if page.description %}
  <div class="book-section">
    <h3>Description</h3>
    <p class="book-description">{{ page.description }}</p>
  </div>
  {% endif %}
</article>

<div class="book-actions-row">
  <a href="{{ '/books' | relative_url }}" class="back-link">&larr; Back to Books</a>
  <div class="book-buttons">
    <button class="btn-edit-book" data-filename="{{ page.name }}">Edit PDF</button>
    <button class="btn-delete-book" data-filename="{{ page.name }}">Delete</button>
  </div>
</div>

<div id="edit-modal" class="modal">
  <div class="modal-content">
    <h3>Edit Book PDF</h3>
    <div class="form-group">
      <label>Upload PDF</label>
      <input type="file" id="edit-pdf-file" accept=".pdf">
    </div>
    <div class="form-group">
      <label>Or PDF URL</label>
      <input type="text" id="edit-pdf-url" placeholder="https://example.com/book.pdf">
    </div>
    <div class="modal-actions">
      <button id="save-edit" class="btn-primary">Save</button>
      <button id="cancel-edit" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h3>Delete Book</h3>
    <p>Are you sure you want to delete this book?</p>
    <div class="modal-actions">
      <button id="confirm-delete" class="btn-delete">Delete</button>
      <button id="cancel-delete" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="message-modal" class="modal">
  <div class="modal-content">
    <h3 id="message-title">Message</h3>
    <p id="message-text"></p>
    <div class="modal-actions">
      <button id="close-message" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<script>
const currentPdfUrl = '{{ page.pdf_url | default: "" }}';

if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
  document.querySelector('.btn-edit-book').style.display = 'none';
  document.querySelector('.btn-delete-book').style.display = 'none';
}

document.getElementById('edit-pdf-url').value = currentPdfUrl;

function showMessage(title, text) {
  document.getElementById('message-title').textContent = title;
  document.getElementById('message-text').textContent = text;
  document.getElementById('message-modal').style.display = 'flex';
}

document.getElementById('close-message').addEventListener('click', function() {
  document.getElementById('message-modal').style.display = 'none';
});

document.querySelector('.btn-edit-book').addEventListener('click', function() {
  document.getElementById('edit-modal').style.display = 'flex';
});

document.getElementById('cancel-edit').addEventListener('click', function() {
  document.getElementById('edit-modal').style.display = 'none';
  document.getElementById('edit-pdf-file').value = '';
});

document.getElementById('save-edit').addEventListener('click', async function() {
  const filename = document.querySelector('.btn-edit-book').dataset.filename;
  let pdfUrl = document.getElementById('edit-pdf-url').value.trim();
  const pdfFile = document.getElementById('edit-pdf-file').files[0];
  
  try {
    if (pdfFile) {
      const formData = new FormData();
      formData.append('file', pdfFile);
      const uploadResponse = await fetch('http://localhost:4567/upload-pdf', { method: 'POST', body: formData });
      const uploadData = await uploadResponse.json();
      if (uploadData.success) {
        pdfUrl = uploadData.url;
      } else {
        showMessage('Error', uploadData.error || 'Failed to upload PDF');
        return;
      }
    }
    
    if (!pdfUrl) {
      showMessage('Error', 'Please upload a PDF or enter a PDF URL');
      return;
    }
    
    const response = await fetch('http://localhost:4567/update-book', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: filename, pdfUrl: pdfUrl })
    });
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('edit-modal').style.display = 'none';
      showMessage('Success', 'PDF added! Page will reload...');
      setTimeout(() => window.location.reload(), 1500);
    } else {
      showMessage('Error', data.error || 'Failed to update');
    }
  } catch (error) {
    showMessage('Error', 'Make sure API server is running: ruby api_server.rb');
  }
});

document.querySelector('.btn-delete-book').addEventListener('click', function() {
  document.getElementById('delete-modal').style.display = 'flex';
});

document.getElementById('cancel-delete').addEventListener('click', function() {
  document.getElementById('delete-modal').style.display = 'none';
});

document.getElementById('confirm-delete').addEventListener('click', async function() {
  const filename = document.querySelector('.btn-delete-book').dataset.filename;
  try {
    const response = await fetch('http://localhost:4567/delete-book', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: filename })
    });
    const data = await response.json();
    if (data.success) {
      window.location.href = '{{ "/books" | relative_url }}';
    } else {
      showMessage('Error', data.error);
    }
  } catch (error) {
    showMessage('Error', error.message);
  }
});
</script>
